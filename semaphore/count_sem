// counting semaphore
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <semaphore.h>
#include <sys/wait.h>

int main() {
    int fd;
    char *ptr;
    char *shm_n = "/my_shm";
    char *sem_n = "/my_sem";
    int sz = 100;

    // SHM
    fd = shm_open(shm_n, O_CREAT | O_RDWR, 0666);
    ftruncate(fd, sz);
    ptr = mmap(0, sz, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);

    // counting sem rill 3
    sem_t *s = sem_open(sem_n, O_CREAT, 0666, 3);

    printf("enter msg: ");
    char in[100];
    fgets(in, 100, stdin);
    strcpy(ptr, in); 

    
    for (int i = 0; i < 3; i++) {
        if (fork() == 0) {
            sem_wait(s); 
            
            printf("child %d in\n", i+1);
            printf("read: %s", ptr);
            sleep(2);
            
            printf("child %d out\n", i+1);
            sem_post(s); 
            
            exit(0);
        }
    }

    
    for (int i = 0; i < 3; i++) wait(NULL);

    
    munmap(ptr, sz);
    shm_unlink(shm_n);
    sem_close(s);
    sem_unlink(sem_n);
    printf("done\n");

    return 0;
}
